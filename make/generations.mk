# ============================================================================
# Generaciones y Rollback
# ============================================================================
# Descripciรณn: Targets para gestionar generaciones del sistema y rollback
# Targets: 7 targets
# ============================================================================

.PHONY: gen-list gen-rollback gen-rollback-commit gen-diff gen-diff-current gen-sizes gen-current

# === Gestiรณn de Generaciones ===

# List all system generations with details
gen-list: ## List all system generations
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ System Generations                      \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Generations List:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@sudo nix-env --list-generations --profile /nix/var/nix/profiles/system
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ List complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	@printf "$(YELLOW)๐ Quick Actions:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "โข Compare generations: $(BLUE)make gen-diff GEN1=n GEN2=m$(NC)\n"
	@printf "โข Rollback:            $(BLUE)make gen-rollback$(NC)\n"
	@printf "\n"

# Rollback to the previous generation
gen-rollback: ## Rollback to previous generation
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             โช System Rollback                         \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Confirmation:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(RED)โ๏ธ  WARNING: You are about to rollback to the previous generation.$(NC)\n"
	@printf "$(YELLOW)This will apply the previous configuration immediately.$(NC)\n"
	@printf "\n"
	@printf "$(RED)Are you sure? Type 'yes' to confirm: $(NC)"; \
	read -r REPLY; \
	if [ "$$REPLY" = "yes" ]; then \
		printf "\n$(YELLOW)Executing rollback...$(NC)\n\n"; \
		sudo nixos-rebuild rollback $(NIX_OPTS); \
		printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(GREEN) โ Rollback completed$(NC)\n"; \
		printf "$(BLUE)System restored to previous generation.$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
	else \
		printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(BLUE)โน๏ธ  Rollback cancelled$(NC)\n"; \
		printf "$(GREEN)โ No changes made$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
	fi

# Rollback to a specific commit and rebuild system
gen-rollback-commit: ## Rollback to specific commit and rebuild (use COMMIT=hash)
	@if [ -z "$$(COMMIT)" ]; then \
		printf "\n"; \
		printf "$(RED)โ Error: COMMIT parameter is required$(NC)\n"; \
		printf "$(YELLOW)Usage: make gen-rollback-commit COMMIT=<hash>$(NC)\n"; \
		exit 1; \
	fi
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             โช Rollback to Specific Commit             \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Verifying Commit:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(BLUE)Checking commit $(YELLOW)$$(COMMIT)$(BLUE)...$(NC)\n"
	@if ! git rev-parse --verify "$$(COMMIT)" >/dev/null 2>&1; then \
		printf "$(RED)โ Commit '$$(COMMIT)' not found$(NC)\n"; \
		printf "$(YELLOW)Check git log for correct hash.$(NC)\n\n"; \
		exit 1; \
	fi
	@COMMIT_FULL=$$(git rev-parse "$$(COMMIT)"); \
	COMMIT_SHORT=$$(git rev-parse --short "$$(COMMIT)"); \
	COMMIT_MSG=$$(git log -1 --format="%s" "$$(COMMIT)"); \
	COMMIT_DATE=$$(git log -1 --format="%ci" "$$(COMMIT)"); \
	printf "$(GREEN)โ Commit found:$(NC)\n"; \
	printf "  $(CYAN)Short Hash:$(NC) $$COMMIT_SHORT\n"; \
	printf "  $(CYAN)Message:   $(NC) $$COMMIT_MSG\n"; \
	printf "  $(CYAN)Date:      $(NC) $$COMMIT_DATE\n\n"; \
	
	@printf "$(GREEN)2.$(NC) $(BLUE)Warning:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(RED)โ๏ธ  CRITICAL WARNING:$(NC)\n"
	@printf "$(YELLOW)  โข HEAD will be detached at this commit$(NC)\n"
	@printf "$(YELLOW)  โข System will be rebuilt from this state$(NC)\n"
	@printf "$(YELLOW)  โข Uncommitted changes will be LOST$(NC)\n\n"
	
	@printf "$(RED)Type 'yes' to proceed: $(NC)"; \
	read -r REPLY; \
	if [ "$$REPLY" = "yes" ]; then \
		printf "\n$(GREEN)3.$(NC) $(BLUE)Executing Rollback:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		printf "$(YELLOW)Saving current state...$(NC)\n"; \
		CURRENT_BRANCH=$$(git branch --show-current 2>/dev/null || echo "detached"); \
		CURRENT_COMMIT=$$(git rev-parse HEAD); \
		printf "$(YELLOW)Checking out $$COMMIT_SHORT...$(NC)\n"; \
		if git checkout "$$(COMMIT)" >/dev/null 2>&1; then \
			printf "$(GREEN)โ Checkout successful$(NC)\n"; \
			printf "$(YELLOW)Rebuilding system...$(NC)\n"; \
			if $(MAKE) --no-print-directory sys-apply-core; then \
				printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
				printf "$(GREEN) โ Rollback successful$(NC)\n"; \
				printf "$(BLUE)System rebuilt from commit: $$COMMIT_SHORT$(NC)\n"; \
				printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
				printf "\n$(YELLOW)Note:$(NC) Repository is now in detached HEAD state at $$COMMIT_SHORT\n"; \
				printf "$(YELLOW)To return to main:$(NC) git checkout main\n\n"; \
			else \
				printf "\n$(RED)โ Rebuild failed$(NC)\n"; \
				printf "$(YELLOW)Reverting to previous state...$(NC)\n"; \
				git checkout "$$CURRENT_COMMIT" >/dev/null 2>&1; \
				if [ "$$CURRENT_BRANCH" != "detached" ]; then \
					git checkout "$$CURRENT_BRANCH" >/dev/null 2>&1; \
				fi; \
				printf "$(BLUE)Repository restored$(NC)\n\n"; \
				exit 1; \
			fi; \
		else \
			printf "$(RED)โ Checkout failed$(NC)\n"; \
			printf "$(YELLOW)Check for uncommitted changes (git status)$(NC)\n\n"; \
			exit 1; \
		fi; \
	else \
		printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(BLUE)โน๏ธ  Rollback cancelled$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
	fi

# Compare any two generations (requires GEN1 and GEN2 variables)
gen-diff: ## Compare two generations (use GEN1=n GEN2=m)
	@if [ -z "$$(GEN1)" ] || [ -z "$$(GEN2)" ]; then \
		printf "\n"; \
		printf "$(RED)โ Error: GEN1 and GEN2 parameters required$(NC)\n"; \
		printf "$(YELLOW)Usage: make gen-diff GEN1=101 GEN2=102$(NC)\n\n"; \
		exit 1; \
	fi
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Generation Diff (Gen $$(GEN1) vs $$(GEN2))      \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Comparing Packages:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@nix-diff /nix/var/nix/profiles/system-$$(GEN1)-link /nix/var/nix/profiles/system-$$(GEN2)-link
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Diff complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Compare current generation with the previous one
gen-diff-current: ## Compare current generation with previous
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Current vs Previous Generation          \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Identifying Generations:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@CURRENT=$$(sudo nix-env --list-generations --profile /nix/var/nix/profiles/system | grep current | awk '{print $$1}'); \
	PREVIOUS=$$((CURRENT - 1)); \
	if [ $$PREVIOUS -gt 0 ]; then \
		printf "$(BLUE)Comparing Gen $$PREVIOUS (previous) vs Gen $$CURRENT (current)...$(NC)\n\n"; \
		nix-diff /nix/var/nix/profiles/system-$$PREVIOUS-link /nix/var/nix/profiles/system-$$CURRENT-link; \
	else \
		printf "$(YELLOW)No previous generation found.$(NC)\n"; \
	fi
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Diff complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Show disk usage for all generations
gen-sizes: ## Show size of generations
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐พ Generations Size Report                 \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Size Analysis:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@sudo nix-env --list-generations --profile /nix/var/nix/profiles/system | \
	awk '{print $$1}' | while read -r gen; do \
		SIZE=$$(du -sh /nix/var/nix/profiles/system-$$gen-link 2>/dev/null | awk '{print $$1}'); \
		printf "  Gen %-4s: %s\n" "$$gen" "$$SIZE"; \
	done
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Report complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Show details of the current generation
gen-current: ## Show current generation info
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Current Generation Info                 \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Active Generation:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@sudo nix-env --list-generations --profile /nix/var/nix/profiles/system | grep current
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Info complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
