# ============================================================================
# Git y Respaldo
# ============================================================================
# Descripciรณn: Targets para operaciones de git, commits y respaldo
# Targets: 6 targets
# ============================================================================

.PHONY: git-add git-commit git-push git-status git-diff git-log

# === Git y Publicaciรณn ===

git-add: ## Stage all changes for git
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐พ Git Stage Changes                       \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Staging Status:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@CHANGED=$$(git status --short | wc -l); \
	if [ $$CHANGED -gt 0 ]; then \
		printf "$(BLUE)Adding all changes to staging area...$(NC)\n"; \
		git add .; \
		printf "$(GREEN)โ Staged $$CHANGED file(s)$(NC)\n"; \
		printf "\n$(BLUE)Changes staged:$(NC)\n"; \
		git status --short | sed 's/^/  /'; \
	else \
		printf "$(YELLOW)โ๏ธ  No changes to stage$(NC)\n"; \
		printf "$(BLUE)Working tree is clean.$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Staging complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

git-commit: ## Quick commit with timestamp
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Git Quick Commit                        \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Committing:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if [ -n "$$(git status --porcelain)" ]; then \
		printf "$(BLUE)Staging changes...$(NC)\n"; \
		git add .; \
		COMMIT_MSG="config: update $$(date '+%Y-%m-%d %H:%M:%S')"; \
		printf "$(BLUE)Creating commit:$(NC) $(GREEN)$$COMMIT_MSG$(NC)\n\n"; \
		git commit -m "$$COMMIT_MSG" || exit 1; \
		COMMIT_HASH=$$(git rev-parse --short HEAD); \
		BRANCH=$$(git branch --show-current); \
		printf "\n$(GREEN)โ Commit created successfully$(NC)\n"; \
		printf "$(BLUE)Hash:$(NC) $(GREEN)$$COMMIT_HASH$(NC)\n"; \
		printf "$(BLUE)Branch:$(NC) $(GREEN)$$BRANCH$(NC)\n"; \
	else \
		printf "$(YELLOW)โ๏ธ  No changes to commit$(NC)\n"; \
		printf "$(BLUE)Working tree is clean. Proceeding...$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Commit operation finished$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

git-push: ## Push to remote using GitHub CLI
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             โ๏ธ  Git Push to Remote                      \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Syncing with Remote:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@BRANCH=$$(git branch --show-current); \
	REMOTE=$$(git remote get-url origin 2>/dev/null | sed -E 's|.*github.com[:/]([^/]+/[^/]+)(\.git)?$$|\1|' | sed 's|\.git$$||'); \
	printf "$(BLUE)Branch:$(NC) $(GREEN)$$BRANCH$(NC)\n"; \
	printf "$(BLUE)Remote:$(NC) $(GREEN)$$REMOTE$(NC)\n\n"; \
	UNPUSHED=$$(git log origin/$$BRANCH..HEAD --oneline 2>/dev/null | wc -l); \
	if [ $$UNPUSHED -gt 0 ]; then \
		printf "$(BLUE)Pushing $$UNPUSHED commit(s)...$(NC)\n"; \
		git push || exit 1; \
		printf "\n$(GREEN)โ Successfully pushed to remote$(NC)\n"; \
	else \
		printf "$(YELLOW)โ๏ธ  Everything up-to-date (no changes to push)$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Push complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

git-status: ## Show git status with GitHub CLI
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Git Repository Status                   \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Configuration:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "  $(BLUE)Host:$(NC)  $(HOSTNAME)\n"
	@printf "  $(BLUE)Flake:$(NC) $(PWD)\n"
	@printf "  $(BLUE)NixOS:$(NC) $$(nixos-version 2>/dev/null | cut -d' ' -f1 || echo 'N/A')\n"
	
	@printf "\n$(BLUE)2. Git Status:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if git rev-parse --git-dir > /dev/null 2>&1; then \
		printf "  $(BLUE)Repository:$(NC) "; \
		REMOTE_URL=$$(git remote get-url origin 2>/dev/null); \
		if [ -n "$$REMOTE_URL" ]; then \
			REPO_NAME=$$(echo "$$REMOTE_URL" | sed -E 's|.*github.com[:/]([^/]+/[^/]+)(\.git)?$$|\1|' | sed 's|\.git$$||'); \
			if [ -n "$$REPO_NAME" ]; then \
				printf "$$REPO_NAME\n"; \
			else \
				printf "$$REMOTE_URL\n"; \
			fi; \
		else \
			printf "$(YELLOW)No remote configured$(NC)\n"; \
		fi; \
		printf "  $(BLUE)Branch:$(NC)     $$(git branch --show-current)\n"; \
		printf "  $(BLUE)Status:$(NC)     "; \
		if git diff-index --quiet HEAD -- 2>/dev/null; then \
			printf "$(GREEN)Clean$(NC)\n"; \
		else \
			printf "$(YELLOW)Uncommitted changes$(NC)\n"; \
		fi; \
		printf "\n$(BLUE)3. Local Changes:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		git status --short | sed 's/^/  /'; \
		printf "\n$(BLUE)4. Recent Commits:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		git log --max-count=3 --pretty=format:"  %C(green)%h%C(reset)  %<(50,trunc)%s  %C(blue)%<(15)%ar%C(reset)" 2>/dev/null; \
	else \
		printf "$(YELLOW)Not a git repository$(NC)\n"; \
	fi
	
	@printf "\n\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Status report complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

git-diff: ## Show uncommitted changes to .nix configuration files
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Git Configuration Changes               \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Diff Analysis:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if git diff --quiet -- '*.nix' 2>/dev/null; then \
		printf "$(GREEN)โ No uncommitted changes to .nix files$(NC)\n"; \
		printf "$(BLUE)All configuration files are clean.$(NC)\n"; \
	else \
		printf "$(BLUE)Uncommitted changes in .nix files:$(NC)\n\n"; \
		CHANGED_FILES=$$(git diff --name-only -- '*.nix' 2>/dev/null | wc -l); \
		ADDED_LINES=$$(git diff --numstat -- '*.nix' 2>/dev/null | awk '{sum+=$$1} END {print sum+0}'); \
		DELETED_LINES=$$(git diff --numstat -- '*.nix' 2>/dev/null | awk '{sum+=$$2} END {print sum+0}'); \
		printf "$(PURPLE)Summary:$(NC)\n"; \
		printf "  โข $(BLUE)Files changed:$(NC) $(GREEN)$$CHANGED_FILES$(NC)\n"; \
		if [ -n "$$ADDED_LINES" ] && [ "$$ADDED_LINES" != "0" ]; then \
			printf "  โข $(BLUE)Lines added:$(NC) $(GREEN)+$$ADDED_LINES$(NC)\n"; \
		fi; \
		if [ -n "$$DELETED_LINES" ] && [ "$$DELETED_LINES" != "0" ]; then \
			printf "  โข $(BLUE)Lines deleted:$(NC) $(RED)-$$DELETED_LINES$(NC)\n"; \
		fi; \
		printf "\n$(BLUE)2. File Changes:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		git diff --stat --color=always -- '*.nix' 2>/dev/null || git diff --stat -- '*.nix'; \
		printf "\n$(BLUE)3. Detailed Diff:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		git diff --color=always -- '*.nix' 2>/dev/null || git diff -- '*.nix'; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Diff complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

git-log: ## Show recent changes from git log
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Recent Git History                      \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Recent Commits:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if git rev-parse --git-dir > /dev/null 2>&1; then \
		git log --max-count=15 --pretty=format:"  %C(green)%h%C(reset)  %<(58,trunc)%s  %C(blue)%<(15)%ar%C(reset)" 2>/dev/null; \
	else \
		printf "$(YELLOW)Not a git repository$(NC)\n"; \
	fi
	
	@printf "\n\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Log complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
