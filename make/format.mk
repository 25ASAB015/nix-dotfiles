# ============================================================================
# Formato, Linting y Estructura
# ============================================================================
# Descripciรณn: Targets para formateo, linting y visualizaciรณn de estructura
# Targets: 4 targets
# ============================================================================

.PHONY: fmt-check fmt-lint fmt-tree fmt-diff

# === Formateo y Estructura ===

# Format all Nix files using nixpkgs-fmt or alejandra
fmt-check: ## Format all nix files
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐จ Formatting Nix Code                     \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Formatting Files:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if command -v alejandra >/dev/null 2>&1; then \
		printf "$(BLUE)Running Alejandra formatter...$(NC)\n"; \
		alejandra .; \
	elif command -v nixpkgs-fmt >/dev/null 2>&1; then \
		printf "$(BLUE)Running nixpkgs-fmt...$(NC)\n"; \
		nixpkgs-fmt .; \
	else \
		printf "$(YELLOW)โ๏ธ  No formatter found (alejandra/nixpkgs-fmt). Skipping.$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Formatting complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

# Lint Nix files for common issues using statix
fmt-lint: ## Check nix files for common issues
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Linting Nix Code                        \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Running Linter:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if command -v statix >/dev/null 2>&1; then \
		printf "$(BLUE)Running Statix linter...$(NC)\n"; \
		statix check .; \
	else \
		printf "$(YELLOW)โ๏ธ  Statix not found. Skipping linting.$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Linting process finished$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

# Show project structure tree
fmt-tree: ## Show project structure tree
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Project Structure                       \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Directory Tree:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if command -v tree >/dev/null 2>&1; then \
		tree -L 2 -I "result*|node_modules|.git"; \
	else \
		find . -maxdepth 2 -not -path '*/.*' -not -path './result*' -not -path './docs/node_modules*'; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Tree view complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"

# Show diff between local and system config
fmt-diff: ## Show diff between local and system config
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Configuration Difference                \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
	
	@printf "$(BLUE)1. Calculating Diff:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(BLUE)Comparing local configuration with /etc/nixos...$(NC)\n"
	@if [ -d "/etc/nixos" ]; then \
		diff -r . /etc/nixos --exclude=".git" --exclude="result*" || true; \
	else \
		printf "$(RED)โ /etc/nixos not found$(NC)\n"; \
	fi
	
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Diff complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
