# ============================================================================
# Anรกlisis y Desarrollo
# ============================================================================
# Descripciรณn: Targets para desarrollo, bรบsqueda de paquetes y anรกlisis
# Targets: 7 targets
# ============================================================================

.PHONY: dev-hosts dev-search dev-search-inst dev-repl dev-shell dev-vm dev-size

# === Anรกlisis y Desarrollo ===

# List all available hosts defined in the flake
dev-hosts: ## List all available hosts
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ฅ๏ธ  NixOS Hosts in Flake                   \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Scanning Configurations:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(BLUE)Searching for host configurations in $(FLAKE_DIR)/hosts...$(NC)\n"
	@if [ -d "hosts" ]; then \
		find hosts -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' | sed 's|^hosts/|  โข |'; \
	else \
		printf "$(RED)โ hosts/ directory not found$(NC)\n"; \
	fi
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Scan complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	@printf "$(YELLOW)๐ Quick Actions:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "โข Deploy host:       $(BLUE)make sys-apply HOSTNAME=<name>$(NC)\n"
	@printf "\n"

# Search for a package in nixpkgs using nix-search
dev-search: ## Search nixpkgs for package (use PKG=name)
	@if [ -z "$(PKG)" ]; then \
		printf "\n"; \
		printf "$(RED)โ Error: PKG parameter is required$(NC)\n"; \
		printf "$(YELLOW)Usage: make dev-search PKG=<package-name>$(NC)\n"; \
		exit 1; \
	fi

ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Nixpkgs Search                          \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Searching for '$(PKG)':$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@nix search nixpkgs $(PKG)
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Search complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Search for a package in currently installed system/user profiles
dev-search-inst: ## Search installed packages (use PKG=name)
	@if [ -z "$$(PKG)" ]; then \
		printf "\n"; \
		printf "$(RED)โ Error: PKG parameter is required$(NC)\n"; \
		printf "$(YELLOW)Usage: make dev-search-inst PKG=<package-name>$(NC)\n"; \
		exit 1; \
	fi

ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Searching Installed Packages            \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)In PATH (which):$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@PKG_PATH=$$(which $(PKG) 2>/dev/null || true); \
	if [ -n "$$PKG_PATH" ]; then \
		printf "  $(GREEN)โ Found:$(NC) $$PKG_PATH\n"; \
		PKG_STORE_PATH=$$(readlink -f "$$PKG_PATH" 2>/dev/null || true); \
		if [ -n "$$PKG_STORE_PATH" ]; then \
			printf "  $(BLUE)Store path:$(NC) $$PKG_STORE_PATH\n"; \
		fi; \
	else \
		printf "  $(YELLOW)Not found in PATH$(NC)\n"; \
	fi
	
	@printf "\n$(GREEN)2.$(NC) $(BLUE)User environment (nix-env):$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@USER_PKGS=$$(nix-env -q 2>/dev/null | grep -i "$(PKG)" || true); \
	if [ -n "$$USER_PKGS" ]; then \
		echo "$$USER_PKGS" | sed 's/^/  /'; \
	else \
		printf "  $(YELLOW)Not found$(NC)\n"; \
	fi
	
	@printf "\n$(GREEN)3.$(NC) $(BLUE)System packages (current-system):$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@SYSTEM_PKGS=$$(nix-store -q --references /run/current-system 2>/dev/null | grep -i "$(PKG)" | head -10 || true); \
	if [ -n "$$SYSTEM_PKGS" ]; then \
		echo "$$SYSTEM_PKGS" | sed 's/^/  /'; \
	else \
		printf "  $(YELLOW)Not found$(NC)\n"; \
	fi
	
	@printf "\n$(GREEN)4.$(NC) $(BLUE)Home Manager profiles:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if [ -d "/etc/profiles/per-user" ]; then \
		HM_PKGS=$$(find /etc/profiles/per-user -name "$(PKG)" -type f 2>/dev/null | head -5 || true); \
		if [ -n "$$HM_PKGS" ]; then \
			echo "$$HM_PKGS" | sed 's/^/  /'; \
		else \
			printf "  $(YELLOW)Not found$(NC)\n"; \
		fi; \
	else \
		printf "  $(YELLOW)Home Manager profiles not found$(NC)\n"; \
	fi
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Search complete$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Start nix repl with the current flake loaded
dev-repl: ## Start nix repl with flake
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ง Nix REPL - Interactive Shell            \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Starting REPL:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@printf "$(BLUE)Loading flake environment...$(NC)\n"
	@printf "$(YELLOW)Useful commands:$(NC)\n"
	@printf "  $(GREEN):q$(NC) or $(GREEN):quit$(NC) - Exit REPL\n"
	@printf "  $(GREEN)outputs$(NC) - View flake outputs\n"
	@printf "  $(GREEN)outputs.nixosConfigurations.$(HOSTNAME)$(NC) - View configuration\n"
	@printf "\n"
	@nix repl --extra-experimental-features repl-flake $(FLAKE_DIR)
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ REPL session ended$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Enter a development shell (uses flake's devShells or basic nix-shell)
dev-shell: ## Enter development shell
ifndef EMBEDDED
	@printf "\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(CYAN)             ๐ Development Shell                       \n$(NC)"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif
	
	@printf "$(GREEN)1.$(NC) $(BLUE)Activating Shell:$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"
	@if nix flake show $(FLAKE_DIR) 2>/dev/null | grep -q "devShells"; then \
		printf "$(BLUE)Entering development shell (nix develop)...$(NC)\n"; \
		nix develop $(FLAKE_DIR); \
	else \
		printf "$(YELLOW)โ๏ธ  No devShells configured in flake, using nix-shell...$(NC)\n"; \
		nix-shell; \
	fi
	
ifndef EMBEDDED
	@printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "$(GREEN) โ Shell session ended$(NC)\n"
	@printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"
	@printf "\n"
endif

# Build and run a VM for testing configuration
dev-vm: ## Build and run VM (use HOST=name)
	@HOST=$${HOST:-$(HOSTNAME)}; \
	if [ -z "$(EMBEDDED)" ]; then \
		printf "\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(CYAN)             ๐ฅ๏ธ  NixOS Virtual Machine ($$HOST)         \n$(NC)"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
	fi; \
	printf "$(GREEN)1.$(NC) $(BLUE)Building VM:$(NC)\n"; \
	printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
	printf "$(BLUE)Building VM from configuration for $$HOST...$(NC)\n"; \
	if nix build ".#nixosConfigurations.$$HOST.config.system.build.vm" 2>/dev/null; then \
		printf "$(GREEN)โ VM built successfully$(NC)\n"; \
		printf "\n$(GREEN)2.$(NC) $(BLUE)Running VM:$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
		printf "$(BLUE)Starting VM... (Press partial Ctrl+A then c to control, or close window to exit)$(NC)\n"; \
		./result/bin/run-*-vm; \
		if [ -z "$(EMBEDDED)" ]; then \
			printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
			printf "$(GREEN) โ VM session ended$(NC)\n"; \
			printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
			printf "\n"; \
		fi; \
	else \
		printf "\n$(RED)โ VM build failed$(NC)\n"; \
		printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(RED) โ Command failed$(NC)\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
		exit 1; \
	fi

# Show closure size of a host or current system
dev-size: ## Show closure size (use HOST=name)
	@HOST_PATH=$${HOST:+$(FLAKE_DIR)#nixosConfigurations.$$HOST.config.system.build.toplevel}; \
	HOST_PATH=$${HOST_PATH:-/run/current-system}; \
	if [ -z "$(EMBEDDED)" ]; then \
		printf "\n"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "$(CYAN)             ๐ System Closure Size Analysis            \n$(NC)"; \
		printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
		printf "\n"; \
	fi; \
	printf "$(GREEN)1.$(NC) $(BLUE)Total Size:$(NC)\n"; \
	printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
	printf "$(BLUE)Closure size for $$HOST_PATH:$(NC)\n"; \
	nix path-info -Sh $$HOST_PATH; \
	printf "\n$(GREEN)2.$(NC) $(BLUE)Top 10 Largest Packages:$(NC)\n"; \
	printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)\n"; \
	nix path-info -rSh $$HOST_PATH | sort -k2 -h | tail -10; \
	if [ -z "$(EMBEDDED)" ]; then \
	printf "\n$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
	printf "$(GREEN) โ Analysis complete$(NC)\n"; \
	printf "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n$(NC)"; \
	printf "\n"; \
	fi
